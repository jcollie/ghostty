using Gtk 4.0;
using Gio 2.0;
using Adw 1;

Adw.Dialog dialog {
  content-width: 700;
  closed => $closed();

  styles [
    "command-palette",
  ]

  Adw.ToolbarView {
    top-bar-style: flat;

    [top]
    Adw.HeaderBar {
      [title]
      Gtk.SearchEntry search {
        hexpand: true;
        placeholder-text: _("Execute a commandâ€¦");
        stop-search => $search_stopped();
        activate => $search_activated();

        styles [
          "search",
        ]
      }
    }

    Gtk.ScrolledWindow {
      min-content-height: 300;

      Gtk.ListView view {
        show-separators: true;
        single-click-activate: true;
        activate => $row_activated();

        model: Gtk.SingleSelection model {
          model: Gtk.FilterListModel {
            incremental: true;

            filter: Gtk.AnyFilter {
              Gtk.StringFilter {
                expression: expr item as <$GhosttyCommand>.title;
                search: bind search.text;
              }

              Gtk.StringFilter {
                expression: expr item as <$GhosttyCommand>.description;
                search: bind search.text;
              }

              Gtk.StringFilter {
                expression: expr item as <$GhosttyCommand>.action-string;
                search: bind search.text;
              }
            };

            model: Gio.ListStore source {
              item-type: typeof<$GhosttyCommand>;
            };
          };
        };

        styles [
          "rich-list",
        ]

        factory: Gtk.BuilderListItemFactory {
          template Gtk.ListItem {
            child: Gtk.Box {
              orientation: horizontal;
              spacing: 0;
              tooltip-text: bind template.item as <$GhosttyCommand>.description;

              Gtk.Button {
                icon-name: bind $get_icon_name(template.item as <$GhosttyCommand>.action-string) as <string>;
                can-shrink: true;
                can-target: false;

                styles [
                  "flat",
                  "icon",
                ]
              }

              Gtk.Box {
                orientation: vertical;
                hexpand: true;

                Gtk.Label {
                  ellipsize: end;
                  halign: start;
                  wrap: false;
                  single-line-mode: true;

                  styles [
                    "title",
                  ]

                  label: bind template.item as <$GhosttyCommand>.title;
                }

                Gtk.Label {
                  ellipsize: end;
                  halign: start;
                  wrap: false;
                  single-line-mode: true;

                  styles [
                    "subtitle",
                    "monospace",
                  ]

                  label: bind $get_subtitle(template.item as <$GhosttyCommand>.action-string, template.item as <$GhosttyCommand>.description) as <string>;
                }
              }

              Gtk.ShortcutLabel {
                accelerator: bind template.item as <$GhosttyCommand>.action-keybind;
                valign: center;
              }
            };
          }
        };
      }
    }
  }
}
